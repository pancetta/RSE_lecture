name: Conda Dependency Update

on:
  schedule:
    # Run weekly on Mondays at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Micromamba
      uses: mamba-org/setup-micromamba@v1
      with:
        micromamba-version: 'latest'
        # Start with minimal environment for the update script
        environment-name: update-env
        create-args: >-
          python>=3.7
          conda-forge::conda-lock
    
    - name: Create conda-lock files for reproducibility
      run: |
        echo "Creating conda-lock files for all environments..."
        
        # Create lock file for base environment
        conda-lock lock --file environment.yml --platform linux-64 --lockfile environment-linux-64.lock
        
        # Create lock file for dev environment
        conda-lock lock --file environment-dev.yml --platform linux-64 --lockfile environment-dev-linux-64.lock
        
        # Create lock files for each lecture (base + lecture-specific)
        # Only process lectures that have non-empty dependencies
        for lecture_dir in lecture_*; do
          # Skip if not a directory
          [ ! -d "$lecture_dir" ] && continue
          # Check if environment.yml exists and has non-empty dependencies
          if [ -f "$lecture_dir/environment.yml" ]; then
            # Use Python to check if dependencies list is non-empty
            has_deps=$(python -c "import yaml; config = yaml.safe_load(open('$lecture_dir/environment.yml')); deps = config.get('dependencies', []); print('yes' if deps and len([d for d in deps if d]) > 0 else 'no')" 2>/dev/null || echo "no")
            
            if [ "$has_deps" = "yes" ]; then
              echo "Processing $lecture_dir (has additional dependencies)..."
              conda-lock lock --file environment.yml --file $lecture_dir/environment.yml \
                --platform linux-64 --lockfile ${lecture_dir}/environment-linux-64.lock
            else
              echo "Skipping $lecture_dir (no additional dependencies, using base environment lock)"
              # Create a symlink to the base environment lock file
              ln -sf ../environment-linux-64.lock ${lecture_dir}/environment-linux-64.lock
            fi
          fi
        done
      shell: bash -el {0}
    
    - name: Test updated environment with current CI checks
      run: |
        # Create a fresh test environment from the updated lock files
        micromamba create -n test-env --file environment-dev-linux-64.lock -y
        micromamba activate test-env
        
        # Run the same checks as CI
        echo "=== Linting with flake8 ==="
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --statistics
        
        echo "=== Checking Python syntax ==="
        python -m py_compile scripts/convert_to_notebooks.py
        for lecture_file in lecture_*/lecture_*.py; do
          echo "Checking syntax: $lecture_file"
          python -m py_compile "$lecture_file"
        done
        
        echo "=== Converting lectures to notebooks ==="
        python scripts/convert_to_notebooks.py
        
        echo "=== Executing notebooks to verify they run ==="
        for lecture_file in lecture_*/lecture_*.py; do
          notebook_file="${lecture_file%.py}.ipynb"
          echo "Executing: $notebook_file"
          jupyter nbconvert --to notebook --execute --inplace "$notebook_file" || {
            echo "ERROR: Failed to execute $notebook_file"
            exit 1
          }
        done
        
        echo "✅ All tests passed with updated dependencies!"
      shell: bash -el {0}
    
    - name: Commit lock files if tests passed
      id: commit
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Check if there are changes
        if [[ -n $(git status --porcelain) ]]; then
          git add environment-linux-64.lock environment-dev-linux-64.lock lecture_*/environment-*.lock
          git commit -m "chore: update conda lock files with latest compatible versions
          
          This automated update was tested and verified to pass all CI checks."
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "No dependency updates available"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
      shell: bash
    
    - name: Create Pull Request
      if: steps.commit.outputs.has_changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: automated-conda-dependency-update
        delete-branch: true
        title: 'chore: Update conda dependencies'
        body: |
          ## Automated Conda Dependency Update
          
          This PR updates the conda lock files with the latest compatible versions of all dependencies.
          
          ### What was tested:
          - ✅ Code linting with flake8
          - ✅ Python syntax validation
          - ✅ Lecture conversion to notebooks
          - ✅ Notebook execution (all lectures)
          
          ### Lock files updated:
          - Base environment lock file
          - Development environment lock file
          - Lecture-specific lock files (all lectures)
          
          The updated dependencies have been tested and verified to work correctly with all lecture materials.
          
          ---
          *This PR was automatically generated by the `conda-dependency-update.yml` workflow.*
        labels: |
          dependencies
          automated
        assignees: ${{ github.repository_owner }}
